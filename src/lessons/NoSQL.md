# ![ico-30 study] Базы данных NoSQL
_________________________________________________

( in process... not ready yet )

_____________________________________

## ![ico-25 icon] Модели данных

Что определяет выбор модели баз данных ?

![ico-20 green-ok] Скорость доступа к данным
![ico-20 green-ok] Масштабируемость

Реляционные базы данных типа MySQL имеют табличную модель данных,
когда все данные размещены во взаимосвязанных ( relation ) таблицах

Горизонтальная масштабируемость здесь становится проблемой...

^^**SQL** ( Structured Query Language ) — универсальный язык запросов^^
^^( используется всеми реляционными системами )^^
^^Язык SQL универсален для всех реляционных хранилищ^^
^^( в случае смены СУБД не придётся переписывать весь код )^^

Нереляционные базы данных ( **NoSQL** ) предоставляют альтернативные варианты моделей баз данных
Это распределённые системы
NoSQL-решения направлены на обеспечение горизонтальной масштабируемости баз данных

Instagram и Facebook используют NoSQL

В отличие от реляционных баз данных, в NoSQL структура данных не является жестко регламентированной
^^в отдельной строке или документе можно добавить произвольное поле без предварительного декларативного изменения структуры БД^^
При необходимости внесения изменений в модель данных это можно сделать на уровне приложения

Реляционная модель хранит бизнес-логику приложения в различных физических таблицах с целью нормализации данных
NoSQL-хранилища оперируют с этими сущностями как с целостными объектами

Однако следует помнить о специфике асинхронного доступа к данным в NoSQL:
трудно обеспечить согласованность данных, когда операции чтения и записи являются асинхронными,
и к моменту записи данных в БД предыдущие значения могли быть изменены...

### ![ico-20 icon] Key / value

Одной из самых простых нетривиальных моделей данных является модель «ключ-значение»
в этой модели данных используется ассоциативный массив ( "карта", "словарь" )
Ключи должны иметь уникальные значения, т.е. не могут дублироваться

### ![ico-20 icon] Document store

Документарнные базы данных

Центральным понятием является понятие «документ»
Документы содержат данные в определенном формате
например, в формате XML или JSON, или в двоичном формате ( BSON )
Каждый документ адресуются в базе данных уникальным ключом, т.е. самый простой способ получить документ - по ключу
Однако язык запросов документарных баз данных обеспечивает также возможность извлекать документы из базы данных по их содержимому

Возможны различные способы организации документов:

• Коллекции
• Теги
• Невидимые метаданные
• Иерархии каталогов

^^Если провести аналогию с реляционными базами данных, коллекции подобны таблицам, а документы - записям^^
^^Однако в таблице каждая запись имеет одинаковую последовательность полей, а различные документы в коллекции могут иметь разные поля^^

### ![ico-20 icon] Graph

Эта модель представляет органзацию данных как элементов, связанных между собой конечным числом отношений
Такие связи могут быть изображены графом, узлами ( вершинами ) которого являются элементы данных
Такая модель подходит для социальных связей, общественного транспорта, дорожных карт, сетевых топологий и т.д.

______________________________________

Существует три основных метода обработки запросов к реляционным базам данных NoSQL

### ![ico-20 icon]  Множественные запросы

^^Не всегда возможно получить все данные одним запросом^^
^^В этом случае для получения требуемых данных делают несколько запросов^^

### ![ico-20 icon] Кэширование, репликация и денормализация

^^Кэш – это высокоскоростной уровень хранения набора данных временного характера^^
^^Основное назначение – ускорение процесса извлечения данных^^
^^Доступ к данным в кэш осуществляется значительно быстрее, чем к основному месту их хранения^^
^^С помощью кэширования становится возможным эффективное повторное использование ранее полученных или вычисленных данных^^

В процессе роста проекта возникает проблема масштабирования баз данных
Основные стратегии масштабирования — репликация и шардинг

**Репликация**

дублироване баз данных
( предполагает использование двух или более серверов для хранения одной и той же базы данных )

_Redis_ представляет собой классическую **master-slave** архитектуру репликации данных

**Master** — основной сервер, где хранятся все данные, и только здесь происходят все изменения в данных
( добавление, обновление, удаление данных )
**Slave** — вспомогательный сервер для считывания данных ( их может быть несколько ),
на который периодически копируются данные с основного сервера

Операции чтения данных выполняются гораздо чаще, чем операции изменения данных,
причем операции внесения изменений в базу данных являются более сложными и затратными
За счет репликации основной сервер освобождается от рутинных операций считывания данных

**peer-to-peer**

альтернатива _master-slave_

Все серверы имеют равные права обслуживать запросы на чтение и запись данных
Информация об обновлении данных передаётся от сервера к серверу по кругу

**sharding**

разделение базы данных на отдельные части так, чтобы каждую из них можно было вынести на отдельный сервер

**денормализация**

Реляционная модель предусматривает обязательную нормализацию данных
Реляционная модель предусматривает хранение данных в виде таблиц и установление связей ( _relations_ ) между таблицами
При этом возникает проблема избыточности, т.е. дублирования фрагментов данных
Нормализация означает приведение структуры таблиц и связей между ними к **нормальной** форме, устраняющей избыточность

________________________________________

**Нормальные формы**

@@@@

[%%%^^Первая нормальная форма^^%%%](https://ru.wikipedia.org/wiki/%D0%9F%D0%B5%D1%80%D0%B2%D0%B0%D1%8F_%D0%BD%D0%BE%D1%80%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F_%D1%84%D0%BE%D1%80%D0%BC%D0%B0)
[%%%^^Вторая нормальная форма^^%%%](https://ru.wikipedia.org/wiki/%D0%92%D1%82%D0%BE%D1%80%D0%B0%D1%8F_%D0%BD%D0%BE%D1%80%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F_%D1%84%D0%BE%D1%80%D0%BC%D0%B0)
[%%%^^Третья нормальная форма^^%%%](https://ru.wikipedia.org/wiki/%D0%A2%D1%80%D0%B5%D1%82%D1%8C%D1%8F_%D0%BD%D0%BE%D1%80%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F_%D1%84%D0%BE%D1%80%D0%BC%D0%B0)
[%%%^^Нормальная форма Бойса — Кодда^^%%%](https://ru.wikipedia.org/wiki/%D0%9D%D0%BE%D1%80%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F_%D1%84%D0%BE%D1%80%D0%BC%D0%B0_%D0%91%D0%BE%D0%B9%D1%81%D0%B0_%E2%80%94_%D0%9A%D0%BE%D0%B4%D0%B4%D0%B0)
[%%%^^Четвёртая нормальная форма^^%%%](https://ru.wikipedia.org/wiki/%D0%A7%D0%B5%D1%82%D0%B2%D1%91%D1%80%D1%82%D0%B0%D1%8F_%D0%BD%D0%BE%D1%80%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F_%D1%84%D0%BE%D1%80%D0%BC%D0%B0)
[%%%^^Пятая нормальная форма^^%%%](https://ru.wikipedia.org/wiki/%D0%9F%D1%8F%D1%82%D0%B0%D1%8F_%D0%BD%D0%BE%D1%80%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F_%D1%84%D0%BE%D1%80%D0%BC%D0%B0)
[%%%^^Шестая нормальная форма^^%%%](https://ru.wikipedia.org/wiki/%D0%A8%D0%B5%D1%81%D1%82%D0%B0%D1%8F_%D0%BD%D0%BE%D1%80%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F_%D1%84%D0%BE%D1%80%D0%BC%D0%B0)

@@@@

_____________________________________

Итак, цель нормализации - устранение избыточности и уменьшение потенциальной противоречивости информации в базе данных
Устранение избыточности производится, как правило, за счёт **декомпозиции** отношений таким образом, чтобы в каждом отношении хранились только первичные факты ( то есть факты, не выводимые из других хранимых фактов )

^^Например, для устранения избыточности можно создать дополнительные таблицы-справочники^^

Денормализация - обратный процесс, предполагающий сознательное допущение избыточности с целью повышения производительности

^^Например, каждый комментарий в блоге может включать не только _id_ автора коммента, также и его имя,^^
^^что избавляет от необходимости повторного обращения к базе данных для получения имени по идентификатору^^

Денормализация увеличивает риск нарушения целостности данных при операциях модификации

^^При изменении имени пользователя в предыдущем примере нужно будет внести изменения во все комментарии этого пользователя^^
^^Таким образом, этот подход работает лучше, когда чтения встречаются гораздо чаще, чем записи^^

### ![ico-20 icon]  Вложенные данные

^^С документарными базами данных, такими как **MongoDB**, обычно помещают больше данных в меньшее количество коллекций^^
^^Например, в SPA для ведения блогов можно сохранять комментарии в документе блога, чтобы упрощает доступ к ним^^
^^Таким образом, каждый документ содержит все необходимые данные, связанные с ним^^

__________________________________________________

## ![ico-25 icon] Принципы ACID

Atomicity / Consistency / Isolation / Durability

Соблюдение всех этих принципов одновременно недостижимо в распределённых системах баз данных NoSQL
( "теорема" Брюера, или CAP )
Альтернативой является **BASE** ( Basically Available, Soft-state, Eventually consistent )
базовая доступность, неустойчивое состояние, согласованность в конечном счёте

### ![ico-25 green-ok] Atomicity

**Атомарность**

Атомарность гарантирует, что никакая транзакция не будет выполнена частично

Транзакция состоит, как правило, из ряда последовательных операций
^^например, банковский перевод средств означает списание нужной суммы с одного счета и зачисление этой суммы на другой счет^^
Все операции, из которых состоит транзакция, должны быть завершены, либо ( в случае невозможности завершения одной из операций транзакции ),
происходит «откат» (rollback) транзакции, т.е. результаты всех уже завершенных операций будут отменены
^^В многопоточном процессе один из потоков может изменить данные между фазами чтения и записи другого потока^^

### ![ico-25 green-ok] Consistency

**Согласованность**

EOT ( End Of Transaction ) - завершение транзакции не должно нарушать согласованность данных

в банковской системе может существовать требование равенства суммы, списываемой с одного счёта, сумме, зачисляемой на другой
Это бизнес-правило и оно не может быть гарантировано только проверками целостности, его должны соблюсти программисты при написании кода транзакций. Если какая-либо транзакция произведёт списание, но не произведёт зачисления, то система останется в некорректном состоянии и свойство согласованности будет нарушено.

Наконец, ещё одно замечание касается того, что в ходе выполнения транзакции согласованность не требуется. В нашем примере, списание и зачисление будут, скорее всего, двумя разными подоперациями и между их выполнением внутри транзакции будет видно несогласованное состояние системы. Однако не нужно забывать, что при выполнении требования изоляции никаким другим транзакциям эта несогласованность не будет видна. А атомарность гарантирует, что транзакция либо будет полностью завершена, либо ни одна из операций транзакции не будет выполнена. Тем самым эта промежуточная несогласованность является скрытой.

### ![ico-25 green-ok] Isolation

**Изолированность**

Во время выполнения транзакции параллельные транзакции не должны оказывать влияния на её результат

### ![ico-25 green-ok] Durability

**Долговечность** ( надежность )

Надежность подразумевает способность восстанавливаться до последнего сохраненного состояния
после непредвиденного сбоя в системе или перебоя в подаче питания

_________________________________________________
